# CARNETES

Das System **Carnetes** basiert auf einer Microservices-Architektur, die eine flexible Erweiterung durch Online-Dienste ermöglicht und spezifische Anforderungen adressiert. Ziel ist es, die Geschäftslogik zu entlasten, während IT-Sicherheit, Benutzer- und Rechteverwaltung zentral gemanagt werden. Diese Funktionen integrieren sich nahtlos in bestehende IT-Infrastrukturen und minimieren Implementierungsaufwand sowie -kosten.

Carnetes bietet Unterstützung für die Integration von **MES**, **ERP** und unterschiedlichen Hardwareumgebungen. Funktionen können mithilfe von **Functions as a Service (FaaS)** schnell implementiert werden, wodurch ereignisgesteuerte Datenverarbeitungen ermöglicht werden. Die Architektur ist vollständig online ausgelegt, was einen jederzeitigen und ortsunabhängigen Zugriff auf Geschäftscode sicherstellt.

Das System gewährleistet fortschrittliche Sicherheitsmechanismen zum Schutz sensibler Daten. Die definierbare **API** erlaubt Interoperabilität mit anderen Systemen und unterstützt eine effiziente Datenbereitstellung.

Zusätzlich übernimmt das System die Wartung und Aktualisierung der zugrunde liegenden IT-Infrastruktur. Falls vorhandene Ressourcen nicht ausreichen, kann das Wartungsmanagement schnell und zuverlässig durchgeführt werden.

## Vorteile von CARNETES
Die Nutzung von CARNETES bietet eine Vielzahl von Vorteilen, die speziell auf IT, das produzierende Gewerbe und SPS abgestimmt sind:

- **Optimale Skalierbarkeit:** Durch stabile und leistungsfähige Strukturen bleibt Ihre IT auch bei hoher Auslastung effizient. Im produzierenden Gewerbe sorgt dies für stabile Produktionsabläufe und eine optimale Ressourcennutzung.
  - Für die IT-Branche bedeutet dies, dass Anwendungen ohne Leistungseinbußen wachsen können.
  - Im produzierenden Gewerbe erlaubt es die Skalierbarkeit, Produktionslinien flexibel an unterschiedliche Auftragsgrößen anzupassen.

- **Sichere Integration:** Nahtlose Kommunikation und zuverlässige Datenverarbeitung schaffen Vertrauen und Effizienz. 
  - In der IT ermöglicht dies eine reibungslose Interaktion zwischen verschiedenen Systemen und Plattformen.
  - In der Industrie ist die Integration entscheidend, um Daten aus verschiedenen Maschinen und SPS zusammenzuführen und zentrale Steuerungen zu ermöglichen.

- **Umfassende Konnektivität:** Breite Unterstützung für Technologien und Protokolle gewährleistet flexible Netzwerke. 
  - IT-Anwendungen können sich problemlos mit externen Systemen verbinden.
  - In der Produktion sichert diese Konnektivität die Interaktion zwischen SPS und Industrieanlagen sowie eine präzise Steuerung von Prozessen.

- **Maximale Erweiterbarkeit:** Ihre IT bleibt technologisch unabhängig und bereit für zukünftige Herausforderungen.
  - IT-Systeme können mit neuen Technologien und Services erweitert werden, ohne die bestehende Struktur zu beeinträchtigen.
  - Produzierende Unternehmen können individuelle Erweiterungen vornehmen, um spezifische Produktionsanforderungen zu erfüllen.

- **Umfassende Interoperabilität:** Einheitliche Standards und innovative Synchronisation optimieren Ihre Infrastruktur.
  - In der IT sorgt dies für eine problemlose Zusammenarbeit zwischen heterogenen Systemen.
  - In der Produktion vereinfacht die Interoperabilität die Integration von Maschinen, SPS und IT-Systemen, wodurch eine zentrale Steuerung und Synchronisation ermöglicht wird.

- **Echte Flexibilität:** Dynamische Anpassungsfähigkeit macht Sie bereit für jede Herausforderung.
  - IT-Anwendungen können flexibel auf neue Anforderungen reagieren, egal ob durch einfache Anpassungen oder komplexe Entwicklungen.
  - In der Industrie ermöglicht diese Flexibilität schnelle Modifikationen an Produktionsprozessen oder SPS-Programmen, um effizient auf Marktveränderungen zu reagieren.

### Skalierbarkeit
Mit CARNETES erleben Sie eine IT-Infrastruktur, die nicht nur leistungsstark, sondern auch hochgradig anpassungsfähig ist. 
- **Dynamische Skalierung:** Der Betrieb auf mehreren Knoten und die intelligente Lastverteilung sorgen dafür, dass die Systemressourcen effizient genutzt werden können. Selbst bei plötzlichen Spitzenlasten bleibt die Performance stabil.
- **Zukunftssicherheit:** Die Unterstützung paralleler Services und flexibler Servicegruppen ermöglicht es Unternehmen, sich auf Wachstum und wechselnde Geschäftsanforderungen vorzubereiten.
- **Vorteile für das produzierende Gewerbe:** Skalierbare Systeme sind in der Lage, Produktionsmengen flexibel zu erhöhen oder zu verringern, während Betriebsprozesse unterbrechungsfrei bleiben. Dies ist besonders wichtig in hochdynamischen Fertigungsumgebungen.
- **IT-Optimierung:** CARNETES bietet eine elastische IT-Infrastruktur, um eine ideale Balance zwischen Kosten und Leistung zu schaffen.

### Integration
CARNETES ermöglicht die nahtlose Verbindung Ihrer Systeme und Datenquellen, um ein Höchstmaß an Effizienz zu erzielen.
- **Vielseitige Authentifizierung:** Die Unterstützung von LDAP und OAuth2 sorgt nicht nur für sichere, sondern auch flexible Authentifizierungsmethoden, die sich leicht in bestehende IT-Umgebungen einfügen.
- **Zentralisierte Datenverwaltung:** Leistungsstarke APIs und robuste ETL-Prozesse sorgen für eine reibungslose Datenkonsolidierung und -verarbeitung. Daten aus verschiedenen Quellen können transformiert und in ein einheitliches Format gebracht werden.
- **Industriespezifische Vorteile:** Im produzierenden Gewerbe bietet CARNETES eine ideale Plattform, um Daten aus Sensoren, SPS und Fertigungsanlagen zusammenzuführen und zentral zu verwalten.
- **Zeitersparnis:** Durch die Automatisierung manueller Datenverarbeitungsschritte bleibt mehr Zeit für strategische Entscheidungen.

### Konnektivität
CARNETES bietet eine umfassende Konnektivität, die es ermöglicht, verschiedenste Systeme und Technologien effizient miteinander zu verbinden.
- **Breite Unterstützung:** Mit Protokollen wie SOAP, REST, MQTT und IBM MQ lassen sich moderne und klassische Systeme gleichermaßen verbinden.
- **Industrieintegration:** Modbus und OPC UA bieten spezialisierte Anbindungen für industrielle Maschinen und SPS, während die nahtlose Integration von Datenbanken wie MsSql, Oracle und SAP R3 die geschäftsrelevanten Prozesse unterstützt.
- **Effiziente Prozesskommunikation:** Die Möglichkeit, Filesysteme, FTP-Dienste und E-Mail-Systeme zu integrieren, verbessert die Zusammenarbeit über verschiedene Plattformen hinweg.
- **IoT-Optimierung:** CARNETES schafft eine Basis für zukunftsorientierte IoT-Lösungen, bei denen Geräte in Echtzeit miteinander kommunizieren können.

### Erweiterbarkeit
Die Erweiterbarkeit von CARNETES ist ein zentraler Bestandteil seiner Leistungsfähigkeit. Die Plattform bietet vielseitige Anpassungsoptionen und Erweiterungsmöglichkeiten.
- **Entwicklung eigener Services:** Nutzen Sie Function-as-a-Service (FaaS) durch den integrierten Lambda-Service, um spezifische Anforderungen umzusetzen.
- **Flexibilität durch Connectoren:** Mit Unterstützung für Java und .Net ermöglicht CARNETES die nahtlose Anbindung neuer Technologien und bleibt technologisch unabhängig.
- **Anpassung für die Industrie:** Für das produzierende Gewerbe können maßgeschneiderte Erweiterungen entwickelt werden, um spezifische Prozessanforderungen zu erfüllen. SPS-Programme können um zusätzliche Logiken erweitert werden.
- **Zukunftssichere Plattform:** Unternehmen können neue Features schrittweise integrieren, ohne bestehende Systeme zu beeinträchtigen.

### Interoperabilität
Interoperabilität steht im Kern der Funktionalität von CARNETES und schafft die Grundlage für eine reibungslose Zusammenarbeit unterschiedlicher Systeme.
- **Standardisierung:** Die Nutzung eines einheitlichen Datenschemas erleichtert die Integration heterogener Systeme.
- **Synchronisierte Prozesse:** Eventhandling sorgt dafür, dass Maschinen und Anwendungen jederzeit synchronisiert bleiben und nahtlos zusammenarbeiten.
- **Maschinen- und IT-Kooperation:** Durch die Integration von SPS, Produktionssystemen und übergeordneten IT-Strukturen wird eine zentrale Steuerung möglich, die den gesamten Betrieb effizienter gestaltet.
- **Flexibles Zusammenspiel:** Dank der Nutzung standardisierter Protokolle wie OPC UA können Maschinen unterschiedlicher Hersteller in einer gemeinsamen Umgebung arbeiten.

### Flexibilität
CARNETES ermöglicht es Unternehmen, agil und zukunftsorientiert zu agieren, indem es flexible Anpassungsmöglichkeiten bietet.
- **Low-Code- und Full-Code-Optionen:** Benutzer können einfache Änderungen vornehmen oder komplexe Anwendungen entwickeln, um spezifische Anforderungen zu erfüllen.
- **Hohe Portabilität:** Die Plattform kann in Cloud-, On-Premise- oder Hybrid-Umgebungen betrieben werden, sodass Unternehmen ihre Infrastruktur gemäß ihren individuellen Bedürfnissen gestalten können.
- **Schnelle Anpassung an Veränderungen:** Unternehmen können ihre IT- und Produktionsprozesse flexibel an neue Marktanforderungen anpassen, sei es durch die Aktualisierung von SPS-Programmen oder die Einführung neuer Technologien.
- **Kosteneinsparungen:** Durch die flexible Anpassung und die Vermeidung umfangreicher Systemumstellungen bleiben Investitionen überschaubar.


---

## Bestandteile und Schlüsselkonzepte von Carnetes

### Microservices
Die Architektur von **Carnetes** basiert auf einer modularen Microservices-Struktur. Jeder Microservice erfüllt eine spezifische Funktion und arbeitet unabhängig von anderen Komponenten. Diese Struktur ermöglicht:
- **Flexibilität:** Jede Komponente kann unabhängig aktualisiert, ausgetauscht oder erweitert werden.
- **Skalierbarkeit:** Systeme können horizontal skaliert werden, indem nur die notwendigen Dienste erweitert werden.
- **Fehlerisolierung:** Ein Fehler in einem Microservice beeinträchtigt nicht das gesamte System.

### API (Application Programming Interface)
Carnetes stellt eine definierbare und gut dokumentierte **API** zur Verfügung, um die Kommunikation mit anderen Systemen und Anwendungen zu erleichtern. Die API bietet:
- **Interoperabilität:** Ermöglicht die nahtlose Integration mit Drittanbieter-Anwendungen wie ERP-Systemen oder IoT-Geräten.
- **Effiziente Datenbereitstellung:** Unterstützt sowohl synchrone als auch asynchrone Datenübertragungen.
- **Sicherheit:** Schutz vor unbefugtem Zugriff durch moderne Authentifizierungs- und Autorisierungsmechanismen.

### CLI (Command Line Interface)
Mit dem **CLI** von Carnetes können Entwickler und Administratoren das System effizient steuern und verwalten. Die wichtigsten Vorteile des CLI sind:
- **Automatisierung:** Skripte und Automatisierungen ermöglichen schnelle und wiederholbare Vorgänge.
- **Benutzerfreundlichkeit:** Intuitive Befehle, die klar dokumentiert sind und gängige Anwendungsfälle abdecken.
- **Zugänglichkeit:** Zugriff auf alle zentralen Funktionen und Einstellungen direkt über die Kommandozeile, ohne zusätzliche grafische Oberflächen zu benötigen.

### FaaS (Functions as a Service)
Das Konzept von **Functions as a Service** (FaaS) ermöglicht es, kleine, spezialisierte Funktionen innerhalb von Carnetes schnell zu entwickeln und bereitzustellen. Die Vorteile von FaaS innerhalb des Systems umfassen:
- **Ereignisgesteuerte Verarbeitung:** Funktionen können auf Basis von Trigger-Ereignissen wie API-Aufrufen oder Datenänderungen ausgelöst werden.
- **Kostenoptimierung:** Ressourcenverbrauch basiert ausschließlich auf der tatsächlichen Nutzung (Pay-as-you-go-Modell).
- **Schnelle Implementierung:** Funktionen sind isoliert und können unabhängig voneinander entwickelt und getestet werden.

---

Mit diesen Schlüsseltechnologien bietet Carnetes eine robuste, flexible und sichere Lösung für IT-Anforderungen, die gezielt auf die Bedürfnisse moderner Unternehmen zugeschnitten ist. Die einzelnen Komponenten interagieren nahtlos miteinander, um Effizienz und Produktivität zu maximieren.

# Services

## Datenbank Service

Der **Datenbank Dienst** stellt Funktionalitäten für die Interaktion mit einer **MsSql-Datenbank** bereit. Dieser Service ermöglicht eine effiziente und flexible Nutzung von Datenbanken innerhalb der IT-Infrastruktur von Carnetes.

---

### Instanzierung

- Es können **mehrere Instanzen** eines Datenbank Dienstes parallel laufen.
- Jede Instanz unterscheidet sich durch ihre spezifische **Verbindung zur Datenbank** (z. B. Nutzer sowie Schema).
- Diese Architektur bietet die Möglichkeit, unterschiedliche Datenbankkonfigurationen unabhängig voneinander zu betreiben.

---

### Gemeinsame Schnittstelle

Jeder Datenbank Dienst basiert auf einer gemeinsamen Schnittstelle, die eine konsistente und vereinheitlichte Nutzung gewährleistet. Es werden zwei Hauptfunktionen bereitgestellt:

#### Query

- Über die **Query-Funktion** können Abfragen definiert werden, deren Ergebnisse im **JSON-Format** zurückgeliefert werden.
- Syntax:
  - Die Querysyntax entspricht **Standard SQL**.
  - Datenbankspezifische Syntax oder spezielle Codes, die vom Datenbank-Managementsystem unterstützt werden, können ebenfalls verwendet werden.

#### Call

- Ein **Call** ermöglicht den direkten Aufruf einer **Stored Procedure**.
- Stored Procedures bieten die Möglichkeit, komplexe Datenbankoperationen zu kapseln und zur Wiederverwendung bereitzustellen.
- Diese Funktion ist ideal, um Datenbankaufrufe zu exportieren und in Anwendungen zu integrieren.

---

### Oracle
Der **Oracle-Service** ermöglicht die Verbindung zu einer Oracle-Datenbank. Die unterstützten Funktionen umfassen:
- **Abfragen:** Direkter Zugriff auf Datenbanken für SELECT-Anweisungen und Abfragen.
- **Datenmanipulation (DML):** Funktionen wie INSERT, UPDATE und DELETE zur Bearbeitung von Daten.
- **Stored Procedures:** Ausführung komplexer Datenbanklogik über gespeicherte Prozeduren. Der Service bietet eine zuverlässige Verbindung zu Oracle-Datenbanken, um große Datenmengen effizient zu verarbeiten.

---

### MsSql
Der **MsSql-Service** ist speziell für die Integration mit Microsoft SQL-Datenbanken konzipiert. Funktionen umfassen:
- **Abfragen:** Zugriff auf Daten über SQL SELECT-Anweisungen.
- **DML-Operationen:** Modifikation und Bearbeitung von Daten über Standard-DML-Anweisungen.
- **Stored Procedures:** Nutzung vordefinierter Logik innerhalb der Datenbank. Mit diesem Service wird eine nahtlose Integration und schnelle Verarbeitung von Daten in Microsoft SQL-Umgebungen gewährleistet.

---

## FileSystem
Der **FileSystem-Service** dient der Speicherung von Daten im Dateisystem. Er ermöglicht:
- **Datenablage:** Speichern von Dateien in definierten Verzeichnissen.
- **Strukturierte Speicherung:** Organisation von Daten für langfristige Nutzung und Backups. Dieser Service ist ideal für Anwendungen, die lokale Dateiverarbeitung benötigen.

---

## FTP
Mit dem **FTP-Service** können Daten sicher und effizient über das File Transfer Protocol übertragen werden. Die Funktionen umfassen:
- **Datentransfer:** Upload und Download von Dateien.
- **Verbindungssicherheit:** Unterstützung von FTP-Protokollen mit Verschlüsselung, z. B. FTPS. Der FTP-Service ermöglicht die Automatisierung von Datentransfers in verschiedene Umgebungen.

---

## Mail
Der **Mail-Service** verbindet sich mit einem Mail-Server und bietet Funktionen wie:
- **E-Mail-Versand:** Nachrichten mit Text und Anhängen senden.
- **SMTP-Unterstützung:** Konfiguration für gängige Mailserver-Standards. Dieser Service ist ideal für Anwendungen, die automatisierten Mailversand benötigen.

---

## MQTT
Der **MQTT-Service** stellt einen MQTT-Broker sowie einen Client zur Verfügung, um Datenquellen zu koppeln. Funktionen:
- **Broker:** Zentraler Punkt für die Kommunikation zwischen MQTT-Publishern und -Subscriber.
- **Client:** Verbindung zu bestehenden MQTT-Datenquellen für Echtzeit-Updates. Der Service eignet sich für IoT-Anwendungen und ereignisbasierte Datenverarbeitung.

---

## ModBus
Der **ModBus-Service** stellt einen Client bereit, um Geräte zu koppeln, die über das ModBus-Protokoll kommunizieren. Funktionen umfassen:
- **Datenkommunikation:** Lesen und Schreiben von Daten auf ModBus-Geräten.
- **Kompatibilität:** Unterstützung für ModBus RTU und TCP. Der Service ist speziell für die Integration industrieller Hardware konzipiert.

---

## IBM MQ
Der **IBM MQ-Service** ermöglicht Messaging im Kontext des IBM Message Queuing-Systems. Funktionen:
- **Nachrichtentransport:** Asynchrone Datenkommunikation zwischen verschiedenen Anwendungen.
- **Zuverlässigkeit:** Sicherstellung der Nachrichtenzustellung durch Warteschlangenmechanismen. Ideal für Anwendungen mit hoher Kommunikationslast.

---

## SOAP
Der **SOAP-Service** bietet Funktionen für die Kommunikation über das SOAP-Protokoll. Er ermöglicht:
- **Webservice-Integration:** Kopplung an SOAP-basierte Dienste.
- **Datenkommunikation:** Austausch von strukturierten Daten mit XML. Der Service eignet sich für ältere Webservice-Standards.

---

## RTSP
Mit dem **RTSP-Service** können Funktionen des Real Time Streaming Protocols genutzt werden. Funktionen:
- **Streaming:** Verarbeitung von Echtzeit-Video- und Audio-Datenströmen.
- **Flexibilität:** Integration in streamingfähige Anwendungen. Der Service ist ideal für Echtzeit-Medienanwendungen.

---

## WaGo Enocean
Der **WaGo Enocean-Service** unterstützt die Nutzung von Geräten, die das WaGo Enocean-Protokoll verwenden. Funktionen:
- **Gerätesteuerung:** Interaktion mit WaGo Enocean-Geräten.
- **Integration:** Kopplung von Sensoren und Aktoren. Dieser Service eignet sich für smarte Gebäudetechnik.

---

## CloudAWS
Der **CloudAWS-Service** bietet Funktionen zur Nutzung von AWS-Diensten, insbesondere:
- **AWS Lambda:** Integration und Aufruf cloudbasierter Funktionen.
- **Skalierbarkeit:** Nutzung weiterer AWS-Dienste wie S3 oder EC2. Der Service optimiert Cloud-basierte Anwendungen.

---

## Cron
Der **Cron-Service** ermöglicht die Verwaltung und Nutzung zeitbasierter Events. Funktionen:
- **Eventplanung:** Definition von wiederholenden Ereignissen (z. B. stündlich, täglich).
- **Automatisierung:** Trigger für zeitgesteuerte Aktionen. Der Service ist ideal für geplante Aufgaben und Batch-Prozesse.

---

## RevPi I/O
Der **RevPi I/O-Service** bietet Funktionen zur Steuerung und Verwaltung von Revolution Pi (RevPi)-Pins. Funktionen:
- **GPIO-Steuerung:** Direkte Ansteuerung von Eingangs- und Ausgangspins.
- **Hardwareintegration:** Verbindung zu industriellen Geräten. Der Service ist speziell für Anwendungen in der Steuerungs- und Automatisierungstechnik konzipiert.

---

## Convert
Der **Convert-Service** ermöglicht die Konvertierung von Daten:
- **Quellenintegration:** Verarbeitung von Daten aus SocketService.
- **Ausgabe:** Export in Excel-Formate. Dieser Service ist ideal für Datenanalyse und Berichterstattung.

---

## AD
Der **AD-Service** unterstützt die Integration und Verwaltung von Active Directory:
- **Benutzerverwaltung:** Verwaltung von Benutzern und Gruppen.
- **Authentifizierung:** Sichere Anmeldung und Zugriffskontrolle. Der Service ist ideal für Unternehmensumgebungen.

---

## Carbone
Mit dem **Carbone-Service** können PDFs aus Carbone-Templates generiert werden. Funktionen:
- **Template-Verarbeitung:** Nutzung von Vorlagen für Dokumente.
- **Automatisierung:** Generierung von Berichten und Formularen. Ideal für Anwendungen, die strukturierte Dokumente erfordern.

---

## Lambda
Der **Lambda-Service** ermöglicht die Bereitstellung von Functions-as-a-Service (FaaS). Funktionen:
- **Flexibilität:** Schnelle Entwicklung und Bereitstellung kleiner Funktionen.
- **Skalierbarkeit:** Ressourcennutzung auf Abruf. Dieser Service ist optimiert für ereignisbasierte Anwendungen und Anpassungen.

### Lambda Service

Der **Lambda Dienst** stellt **Function as a Service (FaaS)** bereit. Dies ermöglicht es, beliebige serverseitige Funktionalitäten zur Laufzeit zu definieren und auszuführen. Derzeit wird **TypeScript** als einzige Sprache unterstützt. 

Die Instanzen eines Lambda-Dienstes stellen eine Art Gruppierung von Funktionen dar, wodurch diese theoretisch auch als eigenständiger Dienst abgebildet werden können. Jede Instanz wird unabhängig von den anderen ausgeführt.

---

#### Aufbau einer Lambda

Eine Lambda-Funktion folgt immer dem gleichen Aufbau, wie im folgenden Beispiel dargestellt:

```typescript
import { Injectable, Action, Init, Destroy } from '@carnetes/core';
import { HttpRequest, HttpResponse } from '@carnetes/runtime';
import { ActionHandler, Logger } from '@carnetes/lambda';

@Injectable()
export class Lambda extends ActionHandler {

    constructor() {
        super();
    }

    @Init()
    public init(): Promise<void> {
        Logger.log(Lambda, 'init ...');
        const promise = new Promise<void>((resolve, reject) => {
            try {
                /**
                 * YOUR CODE
                 */
                Logger.log(Lambda, 'init complete');
                resolve();
            } catch (exception) {
                reject(exception);
            }
        });
        return promise;
    }

    @Destroy()
    public destroy(): Promise<void> {
        Logger.log(Lambda, 'destroy ...');
        const promise = new Promise<void>((resolve, reject) => {
            try {
                /**
                 * YOUR CODE
                 */
                Logger.log(Lambda, 'destroy complete');
                resolve();
            } catch (exception) {
                reject(exception);
            }
        });
        return promise;
    }

    @Action({
        arguments: [
            { name: 'value', type: String, array: false }
        ],
        return: { type: String, array: false }
    })
    public handleAction(value: string, request: HttpRequest, response: HttpResponse): Promise<string> {
        Logger.log(Lambda, 'handleAction ...');
        const promise = new Promise<string>((resolve, reject) => {
            try {
                /**
                 * YOUR CODE
                 */
                Logger.log(Lambda, 'handleAction complete');
                resolve(value);
            } catch (exception) {
                Logger.error(Lambda, exception);
                reject(exception);
            }
        });
        return promise;
    }

}
```

#### Einsprungpunkte

Es gibt drei Einsprungpunkte, die je nach Zustand der Lambda-Funktion aufgerufen werden:

1. **Init**:
   - Wird einmalig beim Start einer Funktionalität ausgeführt.
   - Beispiel: Ressourcen initialisieren, Verbindungen herstellen.

2. **Destroy**:
   - Wird ausgeführt, wenn die Funktion beendet wird.
   - Beispiel: Ressourcen freigeben, Verbindungen schließen.

3. **handleAction**:
   - Enthält die Hauptlogik der Funktion.
   - Wird bei jedem Aufruf der Lambda-Funktion ausgeführt.
   - Die Parameter werden in der **Annotation** definiert und müssen in der Handlerfunktion entsprechend verarbeitet werden.

---

#### Aktualisierung einer Lambda

##### Online über die Weboberfläche
- Änderungen können direkt in der **Weboberfläche** durchgeführt werden.
- Nach einer Änderung kann die Funktion über die Aktionen **Deploy** und **Undeploy** online oder offline gesetzt werden.

##### Dateibasierte Bearbeitung
- Der Funktionscode befindet sich unter dem Verzeichnis:
```
carnetes/package/@carnetes/lambda/.instance/{instance_name}/actions/{func_name}
```

- Die Funktionalität wird in der Datei 'lambda.ts' bearbeitet.
- Alternativ kann der gesamte Actions-Ordner ausgetauscht werden, um ein Update durchzuführen.
- **Neustart des Brokerdienstes**:
- Nach Änderungen sollte der Brokerdienst neugestartet werden, um die Aktualisierungen zu übernehmen.

---


# Authentifikation

Die Authentifikation ist ein zentraler Bestandteil der Sicherheitsarchitektur von Carnetes und stellt sicher, dass nur autorisierte Benutzer und Systeme Zugriff auf geschützte Ressourcen erhalten. Dieses Kapitel bietet eine umfassende Übersicht über die verfügbaren Authentifikationsmethoden, mögliche Erweiterungen und spezifische Konfigurationen wie die Integration eines Active Directory Services.

---

## Anmeldemethoden

### Anmeldung über OAuth2
- **OAuth2** wird als Authentifikationsprotokoll verwendet und bietet eine flexible Lösung für die sichere Anmeldung.
- Mit der **OpenID-Erweiterung** wird eine präzise Identitätsverifizierung und der Zugriff auf erweiterte Nutzerinformationen ermöglicht.

### Rechteverwaltung für Clients
- Jeder Client besitzt **eigene Rechte (Scopes)**, die individuell definiert werden können, um den Zugriff auf Ressourcen zu steuern.

---

## Verfügbare Scopes
Die folgenden Scopes stehen zur Verfügung und definieren den Umfang der Rechte:
- **Admin**: Administrative Zugriffsrechte.
- **Profile**: Zugriff auf grundlegende Benutzerdaten wie Name und Avatar.
- **Email**: Zugriff auf die registrierte E-Mail-Adresse.
- **Groups**: Zugriff auf Gruppenmitgliedschaften und deren Daten.
- **Permissions**: Verwaltung und Prüfung von Berechtigungen.
- **SocketService**: Zugriff auf Aktionen und Events im SocketService.
- **ActiveDirectory**: Integration und Zugriff auf Active Directory.
- **Client Certificate**: Nutzung clientseitiger Zertifikate zur Authentifikation.
- **TOTP**: Unterstützung für Time-based One-Time Passwords (2-Faktor-Authentifizierung).

---

## Authentifizierungsmethoden
Carnetes unterstützt die folgenden Authentifizierungsmethoden:

- **Basic Authentication**:
  - Eigene Nutzerverwaltung mit Benutzername und Passwort.

- **SSPI**:
  - Für nahtlose Authentifizierung innerhalb von Windows-Umgebungen.

- **PKI**:
  - Zertifikatsbasierte Authentifizierung mit hohen Sicherheitsstandards.

- **Active Directory Service (ADS)**:
  - Erweiterte Integration von Active Directory zur zentralen Verwaltung von Benutzern und Zugriffsrechten.
  - ADS ermöglicht Single-Sign-On (SSO) und vereinfachte Synchronisation von Benutzerdaten direkt aus einer Active Directory-Instanz.
  - Die Integration erfolgt über **LDAP**-Protokoll, um Benutzerdaten sicher und effizient abzugleichen.

- **Erweiterungen**:
  - Zusätzliche Authentifizierungsmethoden können unter **carnetes/authentication** integriert werden. Dies bietet Flexibilität bei der Implementierung spezieller Anforderungen, wie z. B. CLM (Certificate Lifecycle Management).

---

## Automatische Anmeldung
- **Automatische Anmeldemethoden** können für jeden OAuth-Client konfiguriert werden, um die Benutzererfahrung zu verbessern und Anmeldevorgänge zu vereinfachen.

---

## Zwei-Faktor-Authentifizierung (2FA)
Zur Erhöhung der Sicherheit unterstützt Carnetes die **2-Faktor-Authentifizierung (2FA)**. Dies umfasst:

- **TOTP (Time-based One-Time Password)**:
  - Unterstützung für gängige Authenticator-Apps wie:
    - **Google Authenticator**: Kostenfrei im [Google Play Store](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=de) erhältlich.
    - **Microsoft Authenticator**: Kostenfrei im [Google Play Store](https://play.google.com/store/apps/details?id=com.azure.authenticator&hl=en-us) verfügbar.
  - Beide Apps generieren Einmal-Codes für die Authentifikation und funktionieren auch offline.

- **Unterstützte Anbieter**:
  - Neben Google und Microsoft Authenticator werden auch Apps wie **Duo Security** oder **Authy** unterstützt.

---

## Sicherheit durch Verschlüsselung
- Alle Kommunikation zwischen Services erfolgt verschlüsselt, um die Integrität und Vertraulichkeit der Daten zu gewährleisten.

---

## Authentifikationskonzept

Die folgende Abbildung veranschaulicht das Authentifikationskonzept von Carnetes:

![Authentifikationskonzept](docs/pics/auth.png)

Die Grafik zeigt die verschiedenen Komponenten und Prozesse innerhalb des Authentifikationsframeworks, einschließlich der sicheren Kommunikation zwischen den Diensten, der Integration von Active Directory und der Rollenverteilung durch die Scopes.

---

## Codebeispiel: PIN-Authentifizierung

Das folgende Beispiel zeigt eine Implementierung einer Authentifikationsroute mit PIN. Dieses Verfahren wird **aus Sicherheitsgründen nicht empfohlen**, da es potenzielle Risiken birgt. Es dient jedoch zur Demonstration, wie eigene Erweiterungen unter **carnetes/authentication** integriert werden können.

```typescript
@Route({
    path: "/start"
})
public route(request: HttpRequest, response: HttpResponse): Promise<void | OpenIDUserInfo> {
    Logger.log(Authentication, 'route ...');
    const promise = new Promise<void | OpenIDUserInfo>((resolve, reject) => {
        try {
            const pin = request.body.pin;
            if (Util.isDefined(pin)) {
                Logger.log(Authentication, 'pin', pin);
                this.execute<any[]>("@socketservice/mssql/**/query/GetLoginByPIN", pin).then(response => {
                    const user = response.data.shift();
                    if (Util.isDefined(user)) {
                        Logger.log(Authentication, 'user', user);
                        resolve({
                            sub: user.RowGuid,
                            name: user.Name,
                            pin: pin,
                            initials: user.Initials
                        });
                    } else {
                        reject(new Error('wrong Pin'));
                    }
                }).catch(error => {
                    Logger.error(Authentication, error);
                    reject(error);
                });
            } else {
                reject(new Error('Nicht korrekt'));
            }
        } catch (exception) {
            Logger.error(Authentication, exception);
            reject(exception);
        }
    });
    return promise;
}
```

### Sicherheitshinweis zur PIN-basierten Authentifizierung

Die PIN-basierte Authentifizierung birgt potenzielle Sicherheitsrisiken, da sie leicht kompromittiert werden kann. Es wird dringend empfohlen, sicherere Authentifizierungsmethoden wie **OAuth2** in Kombination mit **TOTP (Time-based One-Time Password)** oder **PKI (Public Key Infrastructure)** zu verwenden.

Dieses Beispiel dient ausschließlich der Demonstration einer möglichen Erweiterung und sollte nicht in produktiven Umgebungen eingesetzt werden, wo höhere Sicherheitsanforderungen bestehen.

---

# Authorization

Die Authorization spielt eine entscheidende Rolle in der Sicherheitsarchitektur von Carnetes, um sicherzustellen, dass der Zugriff auf geschützte Ressourcen streng kontrolliert und verwaltet wird. Dieses Kapitel bietet eine Übersicht über die Mechanismen zur Zugriffskontrolle, die Flexibilität von Autorisierungs-Händlern und die Möglichkeiten zur Erweiterung.

---

## Blocken von Zugriffen

- Mit dem Authorization-Framework von Carnetes können **Zugriffe gezielt blockiert** werden, basierend auf spezifischen Bedingungen oder definierten Regeln.
- Durch die Implementierung granularer Kontrollmechanismen wird sichergestellt, dass nur berechtigte Benutzer und Systeme Zugriff auf bestimmte Ressourcen erhalten.
- Beispiele für blockierte Zugriffe:
  - Ungültige oder abgelaufene Token.
  - Fehlende Berechtigungen innerhalb eines definierten Scopes.
  - Verstöße gegen Zugriffsbeschränkungen, die auf Benutzerrollen oder anderen Richtlinien basieren.

---

## Autorisierungs-Händler

- **Autorisierungs-Händler** sind zentrale Bausteine im Authorization-Framework und übernehmen die Prüfung, ob eine Anfrage den geltenden Zugriffsvorgaben entspricht.
- Sie ermöglichen die Auswertung von Berechtigungen auf Basis von:
  - Benutzerrollen.
  - Token-Scopes.
  - Regeln für spezifische Ressourcen oder Endpunkte.

### Flexibilität durch Erweiterbarkeit

- Autorisierungs-Händler sind vollständig modular aufgebaut und können **beliebig erweitert** werden.
- Diese Erweiterbarkeit ermöglicht die Integration unternehmensspezifischer Anforderungen oder zusätzlicher Logik für Zugriffskontrollen.
- Neue Händler können unter Berücksichtigung der bestehenden Architektur einfach hinzugefügt werden, um spezifische Geschäftsanforderungen abzudecken.

Das Authorization-Framework von Carnetes ermöglicht die einfache Erweiterung der Zugriffskontrollen durch die Erstellung und Integration eigener Autorisierungs-Händler. Diese Erweiterungen können direkt im Pfad **carnetes/authorization/** abgelegt oder über die Weboberfläche bearbeitet werden.

---

## Unterstützung mehrerer Autorisierungs-Händler

- Jeder **OAuth-Client** kann mehrere Autorisierungs-Händler haben, um komplexe Zugriffskontrollen zu realisieren.
- Diese Konfiguration ermöglicht es, die Anforderungen verschiedener Ressourcen oder Dienste innerhalb eines Clients individuell zu adressieren.
- Die parallele Nutzung mehrerer Händler verbessert die Granularität und Effizienz der Zugriffskontrolle.

---

## Beispiel: Erweiterung der Authorization

Der folgende Code zeigt, wie die Authorization erweitert werden kann. Diese Erweiterung kann unter dem Pfad **carnetes/authorization/** abgelegt werden oder über die Weboberfläche von Carnetes einfach bearbeitet werden:

```typescript
import { Injectable } from '@carnetes/core';
import { Authorizator, OAuth2Client, Logger, OpenIDUserInfo } from '@carnetes/authorization';

@Injectable()
export class Authorization extends Authorizator {

    public authorize(user: OpenIDUserInfo, client: OAuth2Client): Promise<boolean> {
        const promise = new Promise<boolean>((resolve, reject) => {
            try {
                // YOUR CODE STARTS HERE
                resolve(true);
            } catch (exception) {
                Logger.error(Authorization, exception);
                reject(exception);
            }
        });
        return promise;
    }

}
```

# Webapp Broker

Die Webapp Broker ist eine flexible und leistungsfähige Anwendung, die auf modernen Technologien wie **JavaScript** und **Angular** basiert. Dieses Kapitel bietet eine Übersicht über die bereitgestellten Funktionen, Deployment-Optionen und spezifische Konfigurationsmöglichkeiten.

---

## Funktionen

### JavaScript und Angular Library
Die Webapp verwendet eine **JavaScript- und Angular-Bibliothek**, die folgende Funktionen bereitstellt:
- **EXECUTE**: Führt definierte Aktionen aus und ermöglicht die Interaktion mit dem Backend.
- **SUBSCRIBE**: Ermöglicht das Abonnieren von Datenströmen oder Events und stellt Echtzeit-Kommunikation sicher.

Diese Funktionen sind zentral für die Implementierung dynamischer und interaktiver Benutzeroberflächen.

---

## Deployment-Optionen

### Deployment auf einem Service
Die Webapp kann einfach auf einem Service deployed werden:
- Legen Sie die Webapp in den **WWW-Ordner** des Servers.
- Aktivieren Sie die Webapp durch die Konfiguration der Datei **carnetes.json**.

### Deployment in einer Java-Umgebung (z. B. Tomcat)
Die Webapp unterstützt auch den Betrieb in einer Java-basierten Umgebung wie **Tomcat**:
- Verwenden Sie ein **Servlet als Proxy**, das sich als Dienst ausgibt.
- Stellen Sie sicher, dass die '.jar'-Datei als **ContextListener** in der Datei **web.xml** konfiguriert wird.

---

## Dictionary

Die Webapp verfügt über ein **eigenes Dictionary**, das zur Datenverarbeitung und Konfiguration verwendet wird:
- Das Dictionary wird **lazy erzeugt**, d. h., es wird nur dann initialisiert, wenn es benötigt wird.
- Diese Architektur trägt zur Effizienz und Flexibilität der Webapp bei.


# Konfiguration

Die Konfiguration eines Dienstes in Carnetes ist sowohl über die Benutzeroberfläche als auch direkt über das Dateisystem möglich. Dieses Kapitel beschreibt die allgemeinen Konfigurationsmöglichkeiten, Anforderungen an die Sicherheit und Zertifikate sowie spezifische Anpassungen zur Authentifikation und Autorisation.

---

## Allgemeine Konfiguration eines Dienstes

### Installation und Konfiguration

- **Über die Benutzeroberfläche**:
  - Ein Dienst kann einfach über Dialoge in der Weboberfläche installiert und konfiguriert werden. Die Benutzerführung begleitet dabei die Einrichtung der Konfiguration.

- **Über das Dateisystem**:
  - Dienste befinden sich unter dem Pfad:
    ```
    carnetes\package\@socketservice
    ```
  - Die Konfigurationen der jeweiligen Dienste werden unter:
    ```
    {service}\.instance\{instancename}\carnetes.json
    ```
    gespeichert.
  - In dieser Datei können je nach Art des Dienstes spezifische Einstellungen wie **Zertifikate**, **Brokereinstellungen** oder **Verbindungen** festgelegt werden.

---

## Sicherheit und Zertifikate

### Nutzung von Zertifikaten

- Für eine gesicherte Kommunikation zwischen den Diensten sowie zum Broker werden **Zertifikate im PEM-Format** benötigt.
- Der Speicherort der Zertifikate ist flexibel wählbar. Wichtig ist jedoch, dass die Dienste entsprechend konfiguriert werden.
- **Zertifikate erneuern**:
  - Im Falle eines abgelaufenen Zertifikats reicht es aus, die Datei im entsprechenden konfigurierten Verzeichnis zu ersetzen.
  - Bei Umbenennungen der Zertifikate müssen alle zugehörigen Konfigurationen angepasst werden.

### Zugriff mittels JWT

- Die Dienste nutzen **Json Web Token (JWT)** für die Zugriffskontrolle.
- JWT wird durch einen Dienst ausgestellt, der nach der **OAuth2-Spezifikation** integriert ist.
- Für die Authentifikation über **Active Directory (AD)** ist ein spezieller Dienst erforderlich, der die Verbindung zum Authorization Server (AS) bereitstellt.

---

## Anpassung von Authentifikation und Autorisation

### Authentifikation

- Die Authentifikation kann flexibel angepasst werden:
  - Unter **Broker > Security / Authentication** kann die jeweilige Instanz direkt bearbeitet werden.
  - Die Loginseite liegt als Referenz im 'www' Ordner der jeweiligen Methode und kann individuell gestaltet werden.
  - Beispiel für ein Input-Element:
    ```html
    <input id="pin" name="pin" type="password" placeholder="Pin" inputmode="none" >
    ```
  - Die Eingaben können in der 'route'-Methode verarbeitet werden, z. B.:
    ```typescript
    const pin = request.body.pin;
    ```

- Alternativ kann die Authentifikation direkt über das Dateisystem bearbeitet werden:
	```
	\carnetes\authentication\{methode}\authentication.ts
	```

Nach einer Anpassung ist ein Neustart des Dienstes erforderlich.

- Bearbeitung über die Webansicht:
- In der Weboberfläche können Änderungen online vorgenommen werden. Über die Aktionen **Deploy** und **Undeploy** kann die Funktion online oder offline gesetzt werden.

### Autorisation

- Die Autorisation kann ebenso individuell gestaltet werden:
- Unter **Broker > Security / Authorization** können Regeln definiert werden, welche Aktionen ein Nutzer zu welchem Zeitpunkt ausführen darf.
